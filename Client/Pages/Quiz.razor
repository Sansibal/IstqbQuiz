@page "/quiz"
@using IstqbQuiz.Shared.Models
@using System.Net

<h3>ISTQB Quiz</h3>

@if (!quizStarted)
{
    <button class="btn btn-primary" @onclick="StartQuiz">Start (40 Fragen)</button>
}
else if (loading)
{
    <p>Fragen werden geladen...</p>
}
else if (questions.Count == 0 && !string.IsNullOrEmpty(errorMessage))
{
    <div class="alert alert-danger" role="alert">
        Ein Fehler ist aufgetreten: @errorMessage
    </div>
}
else if (questions.Count == 0 && string.IsNullOrEmpty(errorMessage))
{
    <div class="alert alert-warning" role="alert">
        Keine Fragen gefunden. Bitte überprüfen Sie, ob die Datei 'questions.json' Fragen enthält.
    </div>
    <button class="btn btn-primary" @onclick="GoToQuiz">Zurück zum Quiz</button>
}
else if (currentIndex < questions.Count)
{
    <p><b>Frage @(@currentIndex + 1) / @questions.Count</b></p>

    <!-- ✅ Hier die Hauptfrage anzeigen -->
    <div class="question-text fs-5 mb-3">@ToMarkup(questions[currentIndex].Text)</div>

    @if (!string.IsNullOrEmpty(questions[currentIndex]!.Diagram))
    {
        <div style="text-align:center;">
            <img src="@questions[currentIndex]!.Diagram"
                alt="Diagramm zur Frage"
                style="max-width:700px;height:auto;display:inline-block;margin-bottom:1em;" />
        </div>
    }

    @if (!string.IsNullOrEmpty(questions[currentIndex]!.Diagram))
    {
        <div style="text-align:center;">
            <img src="@questions[currentIndex]!.Diagram"
                alt="Diagramm zur Frage"
                style="max-width:700px;height:auto;display:inline-block;margin-bottom:1em;" />
        </div>
    }

    @if (questions[currentIndex]!.Table != null && questions[currentIndex]?.Table?.Count > 0 && questions[currentIndex]?.Table?[0] != null)
    {
        <table class="table table-bordered table-sm mb-2">
            <thead>
                <tr>
                    @foreach (var col in questions[currentIndex].Table[0].Keys)
                    {
                        <th>@col</th>
                    }
                </tr>
            </thead>
            <tbody>
                @foreach (var row in questions[currentIndex].Table)
                {
                    <tr>
                        @foreach (var val in row.Values)
                        {
                            <td>@val</td>
                        }
                    </tr>
                }
            </tbody>
        </table>
    }

    @if (!string.IsNullOrEmpty(questions[currentIndex]!.PostText))
    {
        <div class="question-posttext">@ToMarkup(questions[currentIndex]!.PostText)</div>
    }

    <ul class="list-unstyled mt-3">
        @for (int i = 0; i < questions[currentIndex]!.Options.Count; i++)
        {
            var localIndex = i;
            <li class="mb-2">
                <button class="btn @(answers[currentIndex] == localIndex ? "btn-primary" : "btn-outline-secondary") w-100 text-start"
                        @onclick="() => Select(localIndex)">
                    @questions[currentIndex]!.Options[i]
                </button>
            </li>
        }
</ul>


    <div class="mt-3 d-flex justify-content-between">
        <button class="btn btn-secondary" @onclick="Prev" disabled="@(currentIndex==0)">Zurück</button>
        <button class="btn btn-primary" @onclick="Next" disabled="@(answers[currentIndex]==null)">
            @(currentIndex == questions.Count - 1 ? "Fertig" : "Weiter")
        </button>
    </div>
}
else
{
    <p>Berechne Ergebnis...</p>
}

@code {
    [Inject]
    private QuestionService QService { get; set; } = default!;

    [Inject]
    private NavigationManager Nav { get; set; } = default!;

    [Inject]
    private QuizState State { get; set; } = default!;

    bool quizStarted = false;
    bool loading = false;
    string errorMessage = string.Empty;
    List<Question> questions = new();
    List<int?> answers = new();
    int currentIndex = 0;

    async Task StartQuiz()
    {
        quizStarted = true;
        loading = true;
        errorMessage = string.Empty;

        try
        {
            questions = await QService.GetRandomAsync(40);
        }
        catch (Exception ex)
        {
            errorMessage = ex.Message;
            return;
        }
        finally
        {
            loading = false;
        }

        if (questions.Count == 0)
        {
            quizStarted = false;
            return;
        }

        answers = Enumerable.Repeat<int?>(null, questions.Count).ToList();
        currentIndex = 0;
        State.UserAnswers.Clear();
    }

    void Select(int choice)
    {
        answers[currentIndex] = choice;
        var questionId = questions[currentIndex].Id;
        State.UserAnswers[questionId] = choice;
    }

    void Next()
    {
        if (currentIndex < questions.Count - 1) currentIndex++;
        else Finish();
    }

    void Prev() => currentIndex = Math.Max(0, currentIndex - 1);

    void Finish()
    {
        int score = questions.Zip(answers, (q, a) => (q, a))
            .Count(t => t.a.HasValue && t.a.Value == t.q.CorrectIndex);
        State.Questions = questions;
        State.Answers = answers;
        State.Score = score;
        Nav.NavigateTo("/result");
    }

    MarkupString ToMarkup(string? s)
    {
        var text = s ?? string.Empty;
        text = WebUtility.HtmlDecode(text);
        text = text.Replace("\r\n", "<br>").Replace("\n", "<br>");
        return (MarkupString)text;
    }

    void GoToQuiz()
    {
        quizStarted = false;
    }
}
