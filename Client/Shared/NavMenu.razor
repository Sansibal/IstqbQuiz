@using Microsoft.AspNetCore.Components.Routing
@using Microsoft.JSInterop
@inject IJSRuntime JS
@inject NavigationManager NavManager

<!-- Mobile Navigation (Burger) -->
<nav class="navbar navbar-dark bg-primary d-lg-none">
    <div class="container-fluid">
        <a class="navbar-brand" href="/">ISTQB Quiz</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNavMobile"
                aria-controls="navbarNavMobile" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNavMobile">
            <ul class="navbar-nav ms-auto mb-2 mb-lg-0">
                <li class="nav-item">
                    <NavLink href="/" Match="NavLinkMatch.All" class="nav-link mobile-nav-link">
                        <i class="bi bi-house-door me-1"></i> Startseite
                    </NavLink>
                </li>
                <li class="nav-item">
                    <NavLink href="quiz" class="nav-link mobile-nav-link">
                        <i class="bi bi-question-circle me-1"></i> CTFL Quiz
                    </NavLink>
                </li>
                <li class="nav-item">
                    <NavLink href="quizctmat" class="nav-link mobile-nav-link">
                        <i class="bi bi-question-circle me-1"></i> CT-MAT Quiz
                    </NavLink>
                </li>
                <li class="nav-item">
                    <NavLink href="quizadvanced">
                        <i class="bi bi-sliders me-1"></i> Quiz (mit Filter)
                    </NavLink>
                </li>
                <li class="nav-item">
                    <NavLink href="result" class="nav-link mobile-nav-link">
                        <i class="bi bi-check2-circle me-1"></i> Ergebnis
                    </NavLink>
                </li>
                <li class="nav-item">
                    <NavLink href="details" class="nav-link mobile-nav-link">
                        <i class="bi bi-list-ul me-1"></i> Details
                    </NavLink>
                </li>
                <li class="nav-item">
                    <NavLink href="danksagung" class="nav-link mobile-nav-link">
                        <i class="bi bi-check2-circle me-1"></i> Danksagung
                    </NavLink>
                </li>
                @if (ShowDebug)
                {
                    <li class="nav-item">
                        <NavLink href="debug" class="nav-link mobile-nav-link">
                            <i class="bi bi-bug me-1"></i> Debug
                        </NavLink>
                    </li>
                    <li class="nav-item">
                        <NavLink href="debugquiz" class="nav-link mobile-nav-link">
                            <i class="bi bi-bug me-2"></i> Debug-Quiz
                        </NavLink>
                    </li>
                }
            </ul>
        </div>
    </div>
</nav>

<!-- Desktop Navigation -->
<nav class="navbar navbar-dark bg-primary d-none d-lg-flex">
    <div class="main-nav-container">
        <div class="nav-brand">
            <a href="/">ISTQB Quiz</a>
        </div>

        <div class="nav-links">
            <NavLink href="/" Match="NavLinkMatch.All">
                <i class="bi bi-house-door me-1"></i> Startseite
            </NavLink>
            <NavLink href="quiz">
                <i class="bi bi-question-circle me-1"></i> CTFL Quiz
            </NavLink>
            <NavLink href="quizctmat">
                <i class="bi bi-question-circle me-1"></i> CT-MAT Quiz
            </NavLink>
            <NavLink href="quizadvanced">
                <i class="bi bi-sliders me-1"></i> Quiz (mit Filter)
            </NavLink>
            <NavLink href="result">
                <i class="bi bi-check2-circle me-1"></i> Ergebnis
            </NavLink>
            <NavLink href="details">
                <i class="bi bi-list-ul me-1"></i> Details
            </NavLink>
            <NavLink href="danksagung">
                <i class="bi bi-list-ul me-1"></i> Danksagung
            </NavLink>
            @if (ShowDebug)
            {
                <NavLink href="debug">
                    <i class="bi bi-bug me-1"></i> Debug
                </NavLink>
                <NavLink href="debugquiz" class="nav-link mobile-nav-link">
                    <i class="bi bi-bug me-2"></i> Debug-Quiz
                </NavLink>
            }
        </div>
    </div>
</nav>

<style>
    .navbar {
        padding: 1rem;
    }

    .navbar-brand {
        color: white !important;
        text-decoration: none;
        font-weight: bold;
        font-size: 1.25rem;
    }

    .main-nav-container {
        display: flex;
        justify-content: space-between;
        align-items: center;
        width: 100%;
    }

    .nav-brand a {
        color: white;
        text-decoration: none;
        font-weight: bold;
        font-size: 1.25rem;
    }

    .nav-links {
        display: flex;
        gap: 1.5rem;
    }

        .nav-links a {
            color: white;
            text-decoration: none;
            display: flex;
            align-items: center;
            padding: 0.5rem;
            border-radius: 0.25rem;
            transition: background-color 0.2s ease-in-out;
        }

            .nav-links a:hover {
                background-color: rgba(255, 255, 255, 0.1);
            }
</style>

@code {
#if DEBUG
    private bool ShowDebug = true;
#else
    private bool ShowDebug = false;
#endif

    private DotNetObjectReference<NavMenu>? navMenuReference;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            navMenuReference = DotNetObjectReference.Create(this);
            await JS.InvokeVoidAsync("setupNavMenuEvents", navMenuReference);
        }
    }

    [JSInvokable]
    public async Task OnResize()
    {
        // Immer Menü schließen bei Resize (Querformat/Hochformat)
        await CloseNavMenu();
    }

    private async Task CloseNavMenu()
    {
        try
        {
            var navMenu = await JS.InvokeAsync<IJSObjectReference>(
                "bootstrap.Collapse.getOrCreateInstance", "#navbarNavMobile");
            await navMenu.InvokeVoidAsync("hide");

            // zusätzlich den Toggle-Button zurücksetzen
            await JS.InvokeVoidAsync("resetNavbarToggle");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error closing nav menu: {ex.Message}");
        }
    }


    public void Dispose()
    {
        navMenuReference?.Dispose();
    }
}

<script>
    window.resetNavbarToggle = () => {
        const toggler = document.querySelector('.navbar-toggler');
        if (toggler) {
            toggler.classList.add('collapsed');
            toggler.setAttribute('aria-expanded', 'false');
        }
    };

    window.setupNavMenuEvents = (navMenuReference) => {
        const navbarCollapse = document.getElementById('navbarNavMobile');

        const mobileNavLinks = document.querySelectorAll('.mobile-nav-link');
        mobileNavLinks.forEach(link => {
            link.addEventListener('click', () => {
                const bsCollapse = bootstrap.Collapse.getInstance(navbarCollapse);
                if (bsCollapse) {
                    bsCollapse.hide();
                }
            });
        });

        window.addEventListener('resize', () => {
            navMenuReference.invokeMethodAsync('OnResize');
        });
    };
</script>
